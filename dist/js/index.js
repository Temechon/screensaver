"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;if(void 0===i)return;return i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return;a=j,b=f,c=g,d=!0,h=j=void 0}},GameObject=function(a){function b(a){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,"__go__",a.scene),this.game=a,this.isVisible=!1,this._children=[],BABYLON.Tags.AddTagsTo(this,"__go__")}return _inherits(b,a),_createClass(b,[{key:"setReady",value:function(){this.computeWorldMatrix(!0),this._children.forEach(function(a){a.computeWorldMatrix(!0)})}},{key:"addChildren",value:function(a){a.parent=this,this._children.push(a)}},{key:"isCollidingWith",value:function(a){if(BABYLON.Tags.MatchesQuery(a,"__go__")){for(var b=0;b<this._children.length;b++)for(var c=0;c<a._children.length;c++)if(this._children[b].intersectsMesh(a._children[c],!0))return!0}else for(b=0;b<this._children.length;b++)if(this._children[b].intersectsMesh(a,!0))return!0}},{key:"dispose",value:function(){var a=!0,c=!1,d=void 0;try{for(var e,f=this._children[Symbol.iterator]();!(a=(e=f.next()).done);a=!0){var g=e.value;g.dispose()}}catch(h){c=!0,d=h}finally{try{!a&&f["return"]&&f["return"]()}finally{if(c)throw d}}_get(Object.getPrototypeOf(b.prototype),"dispose",this).call(this)}},{key:"runAnim",value:function(a,b){var c=0,d=0,e=function(){c++,c===d&&b()},f=a.speed||1,g=a.loop||!1,h=this;this._children.forEach(function(c){(c.skeleton||0!=c.animations.length)&&(d++,"undefined"==typeof b?h.getScene().beginAnimation(c,a.start,a.end,g,f):h.getScene().beginAnimation(c,a.start,a.end,g,f,e))})}},{key:"material",set:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=this._children[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;g.material=a}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}}}]),b}(BABYLON.Mesh),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),BugGenerator=function(){function a(b){_classCallCheck(this,a),this.game=b,this.scene=b.scene,this.radius=30,this.textures=[],this.textures.green=new BABYLON.Texture("assets/bug/CrawlingBug-Green.jpg",this.scene),this.textures.red=new BABYLON.Texture("assets/bug/CrawlingBug-Red.jpg",this.scene),this.textures.purple=new BABYLON.Texture("assets/bug/CrawlingBug-Purple.jpg",this.scene)}return _createClass(a,[{key:"addShadow",value:function(a){var b=this;a._children.forEach(function(a){b.game.generator.getShadowMap().renderList.push(a)})}},{key:"initBug",value:function(a){var b=this,c=this._generatePath(),d=this.scene.getMaterialByName("green");d||(d=a._children[0].material.clone("green",!0),d.subMaterials[0].diffuseTexture=this.textures.green);var e=this.scene.getMaterialByName("red");e||(e=a._children[0].material.clone("red",!0),e.subMaterials[0].diffuseTexture=this.textures.red);var f=Math.random(),g=Game.randomNumber(.25,1);.75>f&&(a.material=e),f>.75&&(g=Game.randomNumber(1.5,2)),Math.random()>.99&&(g=Game.randomNumber(2.5,4.5),a.material=d);var h=1/g*2;a.scaling.copyFromFloats(1,1,1),a.scaling.scaleInPlace(g),a.animations=[];var i=[],j=0,k=new BABYLON.Animation("moveAnimation","position",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);a.position.copyFrom(c[0]);for(var l=c[0],m=function(b){BABYLON.Vector3.DistanceSquared(l,c[b])>1&&(i.push({frame:j,value:c[b]}),k.addEvent(new BABYLON.AnimationEvent(j,function(){b<c.length-1&&a.lookAt(c[b+1])})),j+=1,l=c[b])},n=1;n<c.length;n++)m(n);k.setKeys(i),a.animations.push(k),this.scene.beginAnimation(a,0,j,!1,.03*h,function(){b.initBug(a)}),a.runAnim({start:50,end:66,loop:!0,speed:1.53*h})}},{key:"createBug",value:function(){var a=this.game.createModel("bug");this.addShadow(a),this.initBug(a)}},{key:"_generatePath",value:function(){var a=BABYLON.Curve3.CreateCubicBezier(this._randomPosition(),this._randomPosition(),this._randomPosition(),this._randomPosition(),60);return a.getPoints()}},{key:"_randomPosition",value:function(){var a=Math.random()*Math.PI*2;return new BABYLON.Vector3(Math.cos(a)*this.radius,0,Math.sin(a)*this.radius)}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();window.addEventListener("DOMContentLoaded",function(){new Game("game-canvas")});var Game=function(){function a(b){var c=this;_classCallCheck(this,a);var d=document.getElementById(b);this.engine=new BABYLON.Engine(d,!0),this.assets=[],this.scene=null,this.generator=null,window.addEventListener("resize",function(){c.engine.resize()}),this.run()}return _createClass(a,[{key:"_initScene",value:function(){var a=new BABYLON.Scene(this.engine);a.clearColor=BABYLON.Color3.Black(),a.ambientColor=BABYLON.Color3.Black();var b=new BABYLON.PointLight("pl",new BABYLON.Vector3(0,9,0),a);b.range=100;var c=BABYLON.Mesh.CreateSphere("light",20,2,a);c.position=b.position;var d=0,e=.15,f=10;a.registerBeforeRender(function(){c.position.y+=e*Math.cos(2*Math.PI*d*f),d+=f/2e4});var g=new BABYLON.StandardMaterial("lightmat",a);g.emissiveColor=BABYLON.Color3.FromInts(255,186,102),g.alpha=.5,c.material=g;var h=new BABYLON.SpriteManager("halomanager","assets/gradient.png",1,128,a),i=new BABYLON.Sprite("halo",h);i.position=c.position,i.size=4,this.generator=new BABYLON.ShadowGenerator(512,b),this.generator.useBlurVarianceShadowMap=!0,this.generator.blurScale=.5,this.generator.setDarkness(.5);var j=new BABYLON.ArcRotateCamera("camera",1.68,1.24,30,BABYLON.Vector3.Zero(),a);a.registerBeforeRender(function(){j.alpha+=.001,j.radius+=e*Math.cos(2*Math.PI*d*.5*f)});var k=BABYLON.Mesh.CreateGround("ground",100,100,1,a);return k.material=new BABYLON.StandardMaterial("",a),k.material.diffuseTexture=new BABYLON.Texture("assets/ground.jpg",a),k.material.diffuseTexture.uScale=5,k.material.diffuseTexture.vScale=5,k.material.bumpTexture=new BABYLON.Texture("assets/bump.png",a),k.material.specularColor=BABYLON.Color3.Black(),k.material.ambientTexture=new BABYLON.Texture("assets/ambient.png",a),k.receiveShadows=!0,a}},{key:"run",value:function(){var a=this;this.scene=this._initScene();var b=new BABYLON.AssetsManager(this.scene),c=b.addMeshTask("bug","","./assets/bug/","bug.babylon");c.onSuccess=function(b){var c=!0,d=!1,e=void 0;try{for(var f,g=b.loadedMeshes[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;h.setEnabled(!1)}}catch(i){d=!0,e=i}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}a.assets.bug={meshes:b.loadedMeshes}},b.onFinish=function(){a.scene.executeWhenReady(function(){a.engine.runRenderLoop(function(){a.scene.render()})}),a._initGame()},b.load()}},{key:"_initGame",value:function(){var a=new BugGenerator(this),b=new Timer(250,this.scene,{autostart:!0,repeat:100,immediate:!0,autodestroy:!0});b.callback=function(){a.createBug()}}},{key:"createModel",value:function(a,b){if(this.assets[a]){b||(b=new GameObject(this));for(var c=this.assets[a],d=c.meshes,e=0;e<d.length;e++)if(d[e].getTotalVertices()>0){var f=d[e].clone(d[e].name,null,!0);b.addChildren(f),d[e].skeleton&&(f.skeleton=d[e].skeleton.clone(),this.scene.stopAnimation(f))}}else console.warn("No asset corresponding.");return b}}],[{key:"randomInt",value:function(a,b){if(a===b)return a;var c=Math.random();return Math.floor(c*(b-a)+a)}},{key:"randomNumber",value:function(a,b){if(a===b)return a;var c=Math.random();return c*(b-a)+a}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Timer=function(){function a(b,c){var d=this,e=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];_classCallCheck(this,a),this._scene=c,this.maxTime=this.currentTime=b,this.isOver=!1,this.paused=!1,this.started=!1,this.callback=null,this.onFinish=null,this.repeat=e.repeat||1,this.autostart=e.autostart||!1,this.autodestroy=e.autodestroy||!1,this.immediate=e.immediate||!1,this._registeredFunction=function(){!d.started||d.isOver||d.paused||d._update()},c.registerBeforeRender(this._registeredFunction),this.autostart&&this.start()}return _createClass(a,[{key:"reset",value:function(){this.currentTime=this.maxTime,this.isOver=!1,this.started=!1,this.paused=!1}},{key:"start",value:function(){this.started=!0}},{key:"pause",value:function(){this.paused=!0}},{key:"stop",value:function(){this.started=!1,this.reset(),this.autodestroy&&this._destroy()}},{key:"_destroy",value:function(){this._scene.unregisterBeforeRender(this._registeredFunction)}},{key:"resume",value:function(){this.paused=!1}},{key:"_update",value:function(){this.currentTime-=this._scene.getEngine().getDeltaTime(),(this.currentTime<=0||this.immediate)&&(this.immediate=!1,this.isOver=!0,-1!=this.repeat&&this.repeat--,this.callback&&this.callback(),this.repeat>0||-1==this.repeat?(this.reset(),this.start()):(this.onFinish&&this.onFinish(),this.autodestroy&&this._destroy()))}}]),a}();